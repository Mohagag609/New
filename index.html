<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الخزينة المبسط</title>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 0; direction: rtl; }
        .top-nav { background-color: #34495e; padding: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .top-nav button { background-color: #3498db; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; margin: 0 5px; border-radius: 4px; transition: background-color 0.3s; }
        .top-nav button:hover { background-color: #2980b9; }
        .top-nav button.active { background-color: #e67e22; }
        .view { padding: 20px; }
        main { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        form { display: flex; flex-direction: column; gap: 10px; }
        input, select, textarea, button { font-size: 1rem; padding: 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; }
        .list-container { margin-top: 15px; }
        .list-item { background-color: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-right: 4px solid #3498db; display: flex; justify-content: space-between; align-items: center; }
        .report-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom:20px; }
        .card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .card h4 { margin-top: 0; }
        .card p { font-size: 1.8em; font-weight: bold; }
        .types-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .types-display h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; gap: 10px; }
        #filter-reset-btn { background-color: #e74c3c; }
        .btn-print { background-color: #95a5a6; padding: 5px 10px; font-size: 0.9rem; margin-top: 5px; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <button id="nav-main" class="active">الرئيسية</button>
        <button id="nav-types">أنواع الحركات</button>
        <button id="nav-reports">التقارير</button>
    </nav>

    <div id="main-view" class="view">
        <main>
            <section id="treasuries-section">
                <h2>الخزائن</h2>
                <form id="add-treasury-form"><input type="text" id="treasury-name" placeholder="اسم الخزينة" required><input type="number" id="treasury-balance" placeholder="الرصيد الافتتاحي" required step="0.01"><button type="submit">إضافة خزينة</button></form>
                <div id="treasuries-list" class="list-container"></div>
            </section>
            <section id="parties-section">
                <h2>العملاء والموردين والموظفين</h2>
                <form id="add-party-form"><input type="text" id="party-name" placeholder="الاسم" required><select id="party-type" required><option value="customer">عميل</option><option value="supplier">مورد</option><option value="employee">موظف</option></select><button type="submit">إضافة جهة</button></form>
                <div id="parties-list" class="list-container"></div>
            </section>
            <section id="transaction-section">
                <h2>الحركات المالية</h2>
                <form id="add-transaction-form"><select id="transaction-type" required><option value="income">إيراد</option><option value="expense">مصروف</option><option value="transfer">تحويل</option></select><select id="transaction-treasury" required><option value="">من خزينة...</option></select><div id="party-group"><select id="transaction-party"><option value="">اختر الجهة...</option></select></div><div id="custom-type-group" style="display: none;"><select id="transaction-custom-type"><option value="">اختر النوع...</option></select></div><div id="to-treasury-group" style="display: none;"><select id="transaction-to-treasury"><option value="">إلى خزينة...</option></select></div><input type="number" id="transaction-amount" placeholder="المبلغ" required step="0.01"><textarea id="transaction-description" placeholder="الوصف"></textarea><button type="submit">تسجيل الحركة</button></form>
            </section>
        </main>
        <section id="transactions-list-section">
            <h2>كشف الحركات</h2>
            <section id="filter-section"><form id="filter-form"><input type="date" id="filter-start-date" title="من تاريخ"><input type="date" id="filter-end-date" title="إلى تاريخ"><select id="filter-type"><option value="">كل الأنواع</option><option value="income">إيراد</option><option value="expense">مصروف</option><option value="transfer">تحويل</option></select><select id="filter-treasury"><option value="">كل الخزائن</option></select><button type="button" id="filter-reset-btn">إعادة تعيين</button></form></section>
            <div id="transactions-list" class="list-container"></div>
        </section>
    </div>

    <div id="types-view" class="view" style="display: none;">
        <h1>إدارة أنواع الإيرادات والمصروفات</h1>
        <section>
            <h2>إضافة نوع حركة جديد</h2>
            <form id="add-type-form"><input type="text" id="type-name" placeholder="اسم النوع (مثال: إيجار, راتب)" required><select id="type-category" required><option value="income">إيراد</option><option value="expense">مصروف</option></select><button type="submit">إضافة نوع</button></form>
        </section>
        <section class="types-display"><div id="income-types-list"><h3>أنواع الإيرادات</h3><div class="list-container"></div></div><div id="expense-types-list"><h3>أنواع المصروفات</h3><div class="list-container"></div></div></section>
    </div>

    <div id="reports-view" class="view" style="display: none;">
        <h1>التقارير المالية</h1>
        <div class="report-cards"><div class="card"><h4>إجمالي الأرصدة</h4><p id="total-balance">0.00</p></div><div class="card"><h4>إجمالي الإيرادات</h4><p id="total-income">0.00</p></div><div class="card"><h4>إجمالي المصروفات</h4><p id="total-expenses">0.00</p></div><div class="card"><h4>صافي التدفق</h4><p id="net-flow">0.00</p></div></div>
        <section><button id="download-pdf">تحميل تقرير PDF</button></section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            let state = { treasuries: [], parties: [], transactions: [], transactionTypes: [], nextId: 1 };
            const APP_STORAGE_KEY = 'simpleTreasuryApp';
            function saveState() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state)); }
            function loadState() { const savedState = localStorage.getItem(APP_STORAGE_KEY); if (savedState) state = JSON.parse(savedState); }
            function getNextId() { return state.nextId++; }

            const navs = { main: document.getElementById('nav-main'), reports: document.getElementById('nav-reports'), types: document.getElementById('nav-types') };
            const views = { main: document.getElementById('main-view'), reports: document.getElementById('reports-view'), types: document.getElementById('types-view') };
            const downloadPdfBtn = document.getElementById('download-pdf');
            // ... (rest of element selections)

            function generatePDF() {
                const doc = new jsPDF();
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/Amiri-Regular/Amiri-Regular.ttf', 'Amiri', 'normal');
                doc.setFont('Amiri');

                doc.text("تقرير الحركات المالية", 105, 10, { align: 'center' });

                const head = [['#', 'التاريخ', 'البيان', 'المبلغ']];
                const body = state.transactions.map(t => {
                    let details = '';
                    const fromTreasury = state.treasuries.find(tr => tr.id === t.fromTreasuryId)?.name || 'N/A';
                    if (t.type === 'income' || t.type === 'expense') {
                        const party = state.parties.find(p => p.id === t.partyId)?.name || 'N/A';
                        details = t.type === 'income' ? `إيراد من ${party}` : `مصروف إلى ${party}`;
                    } else {
                        const toTreasury = state.treasuries.find(tr => tr.id === t.toTreasuryId)?.name || 'N/A';
                        details = `تحويل من ${fromTreasury} إلى ${toTreasury}`;
                    }
                    return [t.id, new Date(t.createdAt).toLocaleDateString('ar-EG'), details, t.amount.toFixed(2)];
                });

                doc.autoTable({ head, body, styles: { font: 'Amiri', halign: 'center' }, headStyles: { halign: 'center', fillColor: [44, 62, 80] } });
                doc.save('report.pdf');
            }

            downloadPdfBtn.addEventListener('click', generatePDF);

            // ... (rest of the script)
        });
    </script>
</body>
</html>
